<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbitrage & Hedging Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-inactive {
            background-color: #e0e7ff;
            color: #4338ca;
        }
        .result-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        .profit {
            color: #16a34a; /* green-600 */
        }
        .loss {
            color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Arbitrage & Hedging Calculator</h1>
            <p class="text-md text-gray-600 mt-2">Find guaranteed profit or calculate bets for minimized loss.</p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 flex justify-center border-b border-gray-300">
            <button id="tab-2way" class="py-2 px-6 font-semibold rounded-t-lg -mb-px tab-active" onclick="showCalculator('2way')">2-Way Bet</button>
            <button id="tab-3way" class="py-2 px-6 font-semibold rounded-t-lg tab-inactive" onclick="showCalculator('3way')">3-Way Bet</button>
            <button id="tab-kalshi" class="py-2 px-6 font-semibold rounded-t-lg tab-inactive" onclick="showCalculator('kalshi')">Sportsbook vs. Exchange</button>
        </div>

        <!-- 2-Way Calculator -->
        <div id="calculator-2way">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Enter Bet Details</h3>
                        <div>
                            <label for="bet-amount-2way" class="block text-sm font-medium text-gray-700 mb-1">Bet Amount ($)</label>
                            <input type="number" id="bet-amount-2way" value="10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Set bet amount for:</label>
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-1-2way" name="fixed-bet-2way" value="1" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                                <label for="fixed-bet-1-2way" class="ml-2 block text-sm text-gray-900">Outcome 1</label>
                            </div>
                            <div>
                                <input type="text" id="odds1-2way" placeholder="Outcome 1 Odds (-110 or 1.91)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                         <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-2-2way" name="fixed-bet-2way" value="2" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="fixed-bet-2-2way" class="ml-2 block text-sm text-gray-900">Outcome 2</label>
                            </div>
                            <div>
                                <input type="text" id="odds2-2way" placeholder="Outcome 2 Odds (120 or 2.20)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <button id="calculate-2way" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">Calculate</button>
                    </div>

                    <!-- Results -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Results</h3>
                        <div id="results-2way" class="p-4 rounded-lg result-card space-y-3">
                            <p class="text-center text-gray-500">Enter odds and bet amount to see results.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3-Way Calculator -->
        <div id="calculator-3way" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Enter Bet Details</h3>
                        <div>
                            <label for="bet-amount-3way" class="block text-sm font-medium text-gray-700 mb-1">Bet Amount ($)</label>
                            <input type="number" id="bet-amount-3way" value="10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-3">
                             <label class="block text-sm font-medium text-gray-700">Set bet amount for:</label>
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-1-3way" name="fixed-bet-3way" value="1" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                                <label for="fixed-bet-1-3way" class="ml-2 block text-sm text-gray-900">Outcome 1</label>
                            </div>
                            <input type="text" id="odds1-3way" placeholder="Outcome 1 Odds" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-2-3way" name="fixed-bet-3way" value="2" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="fixed-bet-2-3way" class="ml-2 block text-sm text-gray-900">Outcome 2</label>
                            </div>
                            <input type="text" id="odds2-3way" placeholder="Outcome 2 Odds" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-3-3way" name="fixed-bet-3way" value="3" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="fixed-bet-3-3way" class="ml-2 block text-sm text-gray-900">Outcome 3</label>
                            </div>
                            <input type="text" id="odds3-3way" placeholder="Outcome 3 Odds" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button id="calculate-3way" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">Calculate</button>
                    </div>

                    <!-- Results -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Results</h3>
                        <div id="results-3way" class="p-4 rounded-lg result-card space-y-3">
                            <p class="text-center text-gray-500">Enter odds and bet amount to see results.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Kalshi Calculator -->
        <div id="calculator-kalshi" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Enter Bet Details</h3>
                        <div>
                            <label for="bet-amount-kalshi" class="block text-sm font-medium text-gray-700 mb-1">Bet Amount ($)</label>
                            <input type="number" id="bet-amount-kalshi" value="10" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="space-y-3">
                             <label class="block text-sm font-medium text-gray-700">Set bet amount for:</label>
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-sb" name="fixed-bet-kalshi" value="sb" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                                <label for="fixed-bet-sb" class="ml-2 block text-sm text-gray-900">Outcome 1 (Sportsbook 'Yes' Side)</label>
                            </div>
                            <input type="text" id="odds-sb" placeholder="Sportsbook Odds (-110 or 1.91)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="radio" id="fixed-bet-ex" name="fixed-bet-kalshi" value="ex" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="fixed-bet-ex" class="ml-2 block text-sm text-gray-900">Outcome 2 (Exchange 'No' Side)</label>
                            </div>
                            <input type="number" id="price-exchange-no" placeholder="Exchange 'No' Price (e.g., 30)" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" min="0" max="100">
                            <!-- Removed manual fee input, added volume tier dropdown -->
                            <div>
                                <label for="kalshi-volume-tier" class="block text-sm font-medium text-gray-700 mb-1">30-Day Volume (Fee Tier)</label>
                                <select id="kalshi-volume-tier" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="1.0">Tier 1: < $1M (1.0x Base Fee)</option>
                                    <option value="0.7">Tier 2: $1M - $10M (0.7x Base Fee)</option>
                                    <option value="0.4">Tier 3: $10M - $100M (0.4x Base Fee)</option>
                                    <option value="0.2">Tier 4: $100M - $250M (0.2x Base Fee)</option>
                                    <option value="0.0">Tier 5: > $250M (0.0x Base Fee)</option>
                                </select>
                            </div>
                        </div>
                        <button id="calculate-kalshi" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md">Calculate</button>
                    </div>

                    <!-- Results -->
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Results</h3>
                        <div id="results-kalshi" class="p-4 rounded-lg result-card space-y-3">
                            <p class="text-center text-gray-500">Enter odds and bet amount to see results.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const tab2Way = document.getElementById('tab-2way');
        const tab3Way = document.getElementById('tab-3way');
        const tabKalshi = document.getElementById('tab-kalshi');
        const calc2WayDiv = document.getElementById('calculator-2way');
        const calc3WayDiv = document.getElementById('calculator-3way');
        const calcKalshiDiv = document.getElementById('calculator-kalshi');
        
        const calculate2WayBtn = document.getElementById('calculate-2way');
        const calculate3WayBtn = document.getElementById('calculate-3way');
        const calculateKalshiBtn = document.getElementById('calculate-kalshi');
        
        const results2WayDiv = document.getElementById('results-2way');
        const results3WayDiv = document.getElementById('results-3way');
        const resultsKalshiDiv = document.getElementById('results-kalshi');

        // --- Core Logic ---

        function convertAmericanToDecimal(americanOdds) {
            const odds = Number(americanOdds);
            if (isNaN(odds)) return null;
            if (odds > 0) return (odds / 100) + 1;
            if (odds < 0) return (100 / Math.abs(odds)) + 1;
            return null;
        }

        function parseOdds(oddsString) {
            if (!oddsString || oddsString.trim() === '') return null;
            const trimmed = oddsString.trim();
            if (trimmed.startsWith('+') || trimmed.startsWith('-')) {
                return convertAmericanToDecimal(Number(trimmed));
            }
            const odds = parseFloat(trimmed);
            if (isNaN(odds)) return null;
            if (trimmed.includes('.') && odds > 1) return odds;
            if (odds >= 100 && Math.floor(odds) === odds) return convertAmericanToDecimal(odds);
            if (odds > 1) return odds;
            return null;
        }

        function formatCurrency(value) {
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }

        /**
         * Calculates the Kalshi fee PER CONTRACT based on the official PDF.
         * Fee = min(Payout Fee, Price Fee) * Volume Multiplier
         * @param {number} contractPrice - The price of the contract (e.g., 0.70 for 70 cents).
         * @param {number} volumeMultiplier - The multiplier from the user's tier (e.g., 1.0, 0.7).
         * @returns {number} The final fee in dollars for a single contract.
         */
        function getKalshiFeePerContract(contractPrice, volumeMultiplier) {
            // Per the PDF:
            // 1. Payout Fee: 1.5% of $1.00 payout = $0.015
            const payoutFee = 0.015;
            // 2. Price Fee: 7.5% of the contract price
            const priceFee = 0.075 * contractPrice;
            
            // The base fee is the *lesser* of the two.
            const baseFee = Math.min(payoutFee, priceFee);
            
            // Apply the volume multiplier
            const finalFee = baseFee * volumeMultiplier;
            return finalFee;
        }


        function displayResults(container, data) {
            let betSlips = '';
            
            // Standard Bet Slips
            if (data.bets) {
                data.bets.forEach((bet, index) => {
                    betSlips += `
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Bet on Outcome ${index + 1}:</span>
                            <span class="font-bold text-gray-800">${formatCurrency(bet)}</span>
                        </div>
                    `;
                });
            }

            // Custom Kalshi Bet Slips
            if (data.isKalshi) {
                betSlips = `
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Bet on Outcome 1 (SB):</span>
                        <span class="font-bold text-gray-800">${formatCurrency(data.bets[0])}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Bet on Outcome 2 (Ex) Stake:</span>
                        <span class="font-bold text-gray-800">${formatCurrency(data.bets[1])}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 pl-4">Number of Contracts:</span>
                        <span class="font-medium text-gray-600">${data.numContracts.toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 pl-4">Fee Tier:</span>
                        <span class="font-medium text-gray-600">${data.feeTier}</span>
                    </div>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-gray-500 pl-4">Exchange Fee Paid:</span>
                        <span class="font-medium text-gray-600">${formatCurrency(data.feePaid)}</span>
                    </div>
                `;
            }

            if (data.isArb) {
                container.innerHTML = `
                    ${data.adjustmentNote || ''}
                    <div class="text-center mb-4">
                        <p class="text-lg font-semibold profit">Arbitrage Opportunity Found!</p>
                        <p class="text-3xl font-bold profit">${data.profitPercentage.toFixed(2)}%</p>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Profit:</span>
                            <span class="font-bold text-lg profit">${formatCurrency(data.totalProfit)}</span>
                        </div>
                        <hr class="my-2">
                        ${betSlips}
                        <hr class="my-2">
                        <div class="flex justify-between items-center font-semibold">
                            <span class="text-gray-600">Total Wagered:</span>
                            <span class="text-gray-900">${formatCurrency(data.totalWagered)}</span>
                        </div>
                        <div class="flex justify-between items-center font-semibold">
                            <span class="text-gray-600">Guaranteed Return:</span>
                            <span class="text-gray-900">${formatCurrency(data.guaranteedReturn)}</span>
                        </div>
                    </div>
                `;
            } else { // No arbitrage, show minimized loss
                container.innerHTML = `
                    ${data.adjustmentNote || ''}
                    <div class="text-center mb-4">
                        <p class="text-lg font-semibold loss">No Arbitrage Opportunity</p>
                        <p class="text-sm text-gray-600">(Implied Probability: ${data.impliedProbability.toFixed(2)}%)</p>
                        <p class="text-3xl font-bold loss">-${data.lossPercentage.toFixed(2)}%</p>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Guaranteed Loss:</span>
                            <span class="font-bold text-lg loss">${formatCurrency(data.totalLoss)}</span>
                        </div>
                        <hr class="my-2">
                        <h4 class="font-semibold text-center text-gray-700">Bets for Minimized Loss</h4>
                        ${betSlips}
                        <hr class="my-2">
                        <div class="flex justify-between items-center font-semibold">
                            <span class="text-gray-600">Total Wagered:</span>
                            <span class="text-gray-900">${formatCurrency(data.totalWagered)}</span>
                        </div>
                         <div class="flex justify-between items-center font-semibold">
                            <span class="text-gray-600">Guaranteed Return:</span>
                            <span class="text-gray-900">${formatCurrency(data.guaranteedReturn)}</span>
                        </div>
                    </div>
                `;
            }
        }

        // --- Event Handlers ---

        function handleCalculate2Way() {
            const fixedBetAmount = parseFloat(document.getElementById('bet-amount-2way').value);
            const odds1 = parseOdds(document.getElementById('odds1-2way').value);
            const odds2 = parseOdds(document.getElementById('odds2-2way').value);
            const fixedBetOn = document.querySelector('input[name="fixed-bet-2way"]:checked').value;

            if (isNaN(fixedBetAmount) || !odds1 || !odds2) {
                results2WayDiv.innerHTML = `<p class="text-center loss">Please enter a valid bet amount and odds.</p>`;
                return;
            }

            let betAmount1, betAmount2, guaranteedReturn;
            if (fixedBetOn === '1') {
                betAmount1 = fixedBetAmount;
                guaranteedReturn = betAmount1 * odds1;
                betAmount2 = guaranteedReturn / odds2;
            } else {
                betAmount2 = fixedBetAmount;
                guaranteedReturn = betAmount2 * odds2;
                betAmount1 = guaranteedReturn / odds1;
            }

            const totalWagered = betAmount1 + betAmount2;
            const totalProb = (1 / odds1) + (1 / odds2);

            if (totalProb < 1) {
                const totalProfit = guaranteedReturn - totalWagered;
                const profitPercentage = (totalProfit / totalWagered) * 100;
                displayResults(results2WayDiv, { isArb: true, profitPercentage, totalProfit, bets: [betAmount1, betAmount2], totalWagered, guaranteedReturn });
            } else {
                const totalLoss = totalWagered - guaranteedReturn;
                const lossPercentage = (totalLoss / totalWagered) * 100;
                displayResults(results2WayDiv, { isArb: false, impliedProbability: totalProb * 100, lossPercentage, totalLoss, bets: [betAmount1, betAmount2], totalWagered, guaranteedReturn });
            }
        }

        function handleCalculate3Way() {
            const fixedBetAmount = parseFloat(document.getElementById('bet-amount-3way').value);
            const odds1 = parseOdds(document.getElementById('odds1-3way').value);
            const odds2 = parseOdds(document.getElementById('odds2-3way').value);
            const odds3 = parseOdds(document.getElementById('odds3-3way').value);
            const fixedBetOn = document.querySelector('input[name="fixed-bet-3way"]:checked').value;

            if (isNaN(fixedBetAmount) || !odds1 || !odds2 || !odds3) {
                results3WayDiv.innerHTML = `<p class="text-center loss">Please enter a valid bet amount and all three odds.</p>`;
                return;
            }
            
            let betAmount1, betAmount2, betAmount3, guaranteedReturn;
            if (fixedBetOn === '1') {
                betAmount1 = fixedBetAmount;
                guaranteedReturn = betAmount1 * odds1;
                betAmount2 = guaranteedReturn / odds2;
                betAmount3 = guaranteedReturn / odds3;
            } else if (fixedBetOn === '2') {
                betAmount2 = fixedBetAmount;
                guaranteedReturn = betAmount2 * odds2;
                betAmount1 = guaranteedReturn / odds1;
                betAmount3 = guaranteedReturn / odds3;
            } else {
                betAmount3 = fixedBetAmount;
                guaranteedReturn = betAmount3 * odds3;
                betAmount1 = guaranteedReturn / odds1;
                betAmount2 = guaranteedReturn / odds2;
            }

            const totalWagered = betAmount1 + betAmount2 + betAmount3;
            const totalProb = (1 / odds1) + (1 / odds2) + (1 / odds3);

            if (totalProb < 1) {
                const totalProfit = guaranteedReturn - totalWagered;
                const profitPercentage = (totalProfit / totalWagered) * 100;
                displayResults(results3WayDiv, { isArb: true, profitPercentage, totalProfit, bets: [betAmount1, betAmount2, betAmount3], totalWagered, guaranteedReturn });
            } else {
                const totalLoss = totalWagered - guaranteedReturn;
                const lossPercentage = (totalLoss / totalWagered) * 100;
                displayResults(results3WayDiv, { isArb: false, impliedProbability: totalProb * 100, lossPercentage, totalLoss, bets: [betAmount1, betAmount2, betAmount3], totalWagered, guaranteedReturn });
            }
        }
        
        function handleCalculateKalshi() {
            const fixedBetAmount = parseFloat(document.getElementById('bet-amount-kalshi').value);
            const oddsSB_raw = document.getElementById('odds-sb').value;
            const priceEX_no_raw = document.getElementById('price-exchange-no').value; // Changed ID
            const selectedTier = document.getElementById('kalshi-volume-tier');
            const volumeMultiplier = parseFloat(selectedTier.value);
            const feeTierText = selectedTier.options[selectedTier.selectedIndex].text;
            const fixedBetOn = document.querySelector('input[name="fixed-bet-kalshi"]:checked').value;

            // --- Parse Inputs ---
            const D1 = parseOdds(oddsSB_raw); // Sportsbook "Yes" Odds
            const kalshi_no_price = parseFloat(priceEX_no_raw) / 100; // This is now the 'No' price directly
            
            if (isNaN(fixedBetAmount) || !D1 || isNaN(kalshi_no_price) || kalshi_no_price <= 0 || kalshi_no_price >= 1) {
                resultsKalshiDiv.innerHTML = `<p class="text-center loss">Please enter valid amounts, odds, and a price between 0 and 100.</p>`;
                return;
            }

            // --- Calculate Exchange Effective Odds ---
            
            // Calculate the fee *per contract*
            const feePerContract = getKalshiFeePerContract(kalshi_no_price, volumeMultiplier);
            
            // The "Odds" (D2) for the exchange side are based on the *total cost* to get a $1 payout.
            // Total cost = price + fee
            // But the fee is per contract, and # of contracts = 1 / price. This is complex.
            // Let's calculate based on a $1 payout, which is 1 contract.
            // Cost to buy 1 contract = (1 * kalshi_no_price) + (1 * feePerContract)
            // Effective Decimal Odds (D2) = Payout / Total Cost = $1.00 / (kalshi_no_price + feePerContract)
            const D2 = 1.0 / (kalshi_no_price + feePerContract);

            // --- Variable Declaration ---
            let betAmount1, betAmount2_stake, guaranteedReturn_ideal, numContracts_ideal;
            let numContracts_whole = 0;
            let adjustmentNote = '';

            // --- Determine "Ideal" (Fractional) Bets ---
            if (fixedBetOn === 'sb') {
                betAmount1 = fixedBetAmount;
                guaranteedReturn_ideal = betAmount1 * D1; // This is the $ payout
                // On Kalshi, $1 payout = 1 contract. So guaranteedReturn = # of contracts.
                numContracts_ideal = guaranteedReturn_ideal;
            } else { // fixedBetOn === 'ex'
                // This is complex. User enters a STAKE.
                betAmount2_stake = fixedBetAmount;
                // How many contracts does this stake buy?
                // Stake = numContracts * (price + fee) -- This is wrong.
                // Stake = numContracts * price. Fee is separate.
                // Let's assume Bet Amount is the STAKE.
                numContracts_ideal = betAmount2_stake / kalshi_no_price;
                guaranteedReturn_ideal = numContracts_ideal; // $1 payout per contract
            }

            // --- Step 2: Adjust to Whole Contracts ---
            numContracts_whole = Math.floor(numContracts_ideal);
            if (numContracts_whole === 0) {
                 resultsKalshiDiv.innerHTML = `<p class="text-center loss">Bet amount is too small to purchase a single contract.</p>`;
                return;
            }
            
            if (numContracts_ideal !== numContracts_whole) {
                 adjustmentNote = `
                    <div classclass="p-3 mb-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md">
                        <p class="font-bold">Bet Adjusted for Whole Contracts</p>
                        <p class="text-sm">Ideal bet was ${numContracts_ideal.toFixed(2)} contracts. This was rounded down to ${numContracts_whole} contracts. Stakes have been re-calculated.</p>
                    </div>
                `;
            }

            // --- Step 3: Re-Calculate Both Sides Based on Whole Contracts ---
            const guaranteedReturn = numContracts_whole; // $1 payout per contract
            
            // Re-calculate Sportsbook bet
            betAmount1 = guaranteedReturn / D1;
            
            // Re-calculate Exchange stake
            betAmount2_stake = numContracts_whole * kalshi_no_price;
            
            // Calculate the final fee
            const feePaid = numContracts_whole * feePerContract;

            // --- Final Calculation ---
            const totalWagered = betAmount1 + betAmount2_stake + feePaid;
            const totalProb = (1 / D1) + (1 / D2); // Use effective odds for probability

            if (totalProb < 1) {
                const totalProfit = guaranteedReturn - totalWagered;
                const profitPercentage = (totalProfit / totalWagered) * 100;
                displayResults(resultsKalshiDiv, { 
                    isArb: true, 
                    isKalshi: true, 
                    profitPercentage, 
                    totalProfit, 
                    bets: [betAmount1, betAmount2_stake], 
                    feePaid,
                    feeTier: feeTierText,
                    numContracts: numContracts_whole,
                    totalWagered, 
                    guaranteedReturn,
                    adjustmentNote
                });
            } else {
                const totalLoss = totalWagered - guaranteedReturn;
                const lossPercentage = (totalLoss / totalWagered) * 100;
                displayResults(resultsKalshiDiv, { 
                    isArb: false, 
                    isKalshi: true, 
                    impliedProbability: totalProb * 100, 
                    lossPercentage, 
                    totalLoss, 
                    bets: [betAmount1, betAmount2_stake],
                    feePaid, 
                    feeTier: feeTierText,
                    numContracts: numContracts_whole,
                    totalWagered, 
                    guaranteedReturn,
                    adjustmentNote
                });
            }
        }

        function showCalculator(type) {
            calc2WayDiv.classList.add('hidden');
            calc3WayDiv.classList.add('hidden');
            calcKalshiDiv.classList.add('hidden');
            
            tab2Way.classList.remove('tab-active', 'text-white');
            tab3Way.classList.remove('tab-active', 'text-white');
            tabKalshi.classList.remove('tab-active', 'text-white');
            
            tab2Way.classList.add('tab-inactive', 'text-indigo-700');
            tab3Way.classList.add('tab-inactive', 'text-indigo-700');
            tabKalshi.classList.add('tab-inactive', 'text-indigo-700');


            if (type === '2way') {
                calc2WayDiv.classList.remove('hidden');
                tab2Way.classList.add('tab-active');
                tab2Way.classList.remove('tab-inactive');
            } else if (type === '3way') {
                calc3WayDiv.classList.remove('hidden');
                tab3Way.classList.add('tab-active');
                tab3Way.classList.remove('tab-inactive');
            } else if (type === 'kalshi') {
                calcKalshiDiv.classList.remove('hidden');
                tabKalshi.classList.add('tab-active');
                tabKalshi.classList.remove('tab-inactive');
            }
        }
        
        // --- Attach Event Listeners ---
        calculate2WayBtn.addEventListener('click', handleCalculate2Way);
        calculate3WayBtn.addEventListener('click', handleCalculate3Way);
        calculateKalshiBtn.addEventListener('click', handleCalculateKalshi);

    </script>
</body>
</html>




